{% extends "base.html" %}

{% block title %}Add New Mentee{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <!-- Success/Error Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="card shadow-lg border-0">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="fas fa-user-graduate me-2"></i>Add New Mentee
                </h3>
                <p class="mb-0 mt-2 opacity-75">Add a new student to the mentorship program</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" id="menteeForm" novalidate>
                    <!-- Student Name -->
                    <div class="mb-4">
                        <label for="name" class="form-label fw-bold">
                            <i class="fas fa-user me-2 text-success"></i>Student Name *
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="name" 
                               name="name" 
                               required 
                               placeholder="Enter student's full name"
                               autocomplete="name"
                               pattern="[A-Za-z\s]{2,50}"
                               title="Name should contain only letters and spaces (2-50 characters)">
                        <div class="invalid-feedback">
                            Please enter a valid name (letters and spaces only, 2-50 characters).
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the student's full name as it appears in official records.
                        </div>
                    </div>

                    <!-- Student ID -->
                    <div class="mb-4">
                        <label for="roll_call" class="form-label fw-bold">
                            <i class="fas fa-id-badge me-2 text-success"></i>Student ID / Roll Number *
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-hashtag"></i>
                            </span>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="roll_call" 
                                   name="roll_call" 
                                   required 
                                   placeholder="e.g., STU001, 123456"
                                   autocomplete="username"
                                   pattern="[A-Za-z0-9]{3,20}"
                                   title="Student ID should be 3-20 characters (letters and numbers only)">
                            <div class="invalid-feedback">
                                Please enter a valid Student ID (3-20 characters, letters and numbers only).
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            A unique identifier for this student (student ID, roll number, etc.)
                        </div>
                    </div>

                    <!-- Subject Selection -->
                    <div class="mb-4">
                        <label for="subject" class="form-label fw-bold">
                            <i class="fas fa-book me-2 text-success"></i>Subject Needed *
                        </label>
                        
                        <!-- Subject Cards for Visual Selection -->
                        <div class="row g-2 mb-3">
                            <div class="col-6 col-md-3">
                                <div class="card subject-card h-100" data-subject="Math">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-calculator fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title mb-1">Math</h6>
                                        <small class="text-muted">7 lessons</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card subject-card h-100" data-subject="English">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-book-open fa-2x text-info mb-2"></i>
                                        <h6 class="card-title mb-1">English</h6>
                                        <small class="text-muted">7 lessons</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card subject-card h-100" data-subject="Science">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-flask fa-2x text-warning mb-2"></i>
                                        <h6 class="card-title mb-1">Science</h6>
                                        <small class="text-muted">3 lessons</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card subject-card h-100" data-subject="Chess">
                                    <div class="card-body text-center p-3">
                                        <i class="fas fa-chess fa-2x text-success mb-2"></i>
                                        <h6 class="card-title mb-1">Chess</h6>
                                        <small class="text-muted">6 lessons</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden select for form submission -->
                        <select class="form-select d-none" id="subject" name="subject" required>
                            <option value="">Choose subject...</option>
                            <option value="Math">Math</option>
                            <option value="English">English</option>
                            <option value="Science">Science</option>
                            <option value="Chess">Chess</option>
                        </select>
                        
                        <div class="invalid-feedback">
                            Please select a subject for tutoring.
                        </div>
                        
                        <!-- Selected Subject Display -->
                        <div id="selectedSubjectDisplay" class="d-none">
                            <div class="alert alert-success d-flex align-items-center">
                                <i class="fas fa-check-circle me-2"></i>
                                <div>
                                    <strong>Selected:</strong> <span id="selectedSubjectName"></span>
                                    <br><small>Lessons will be automatically set based on this subject.</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" id="changeSubject">
                                    Change
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lesson Info Display -->
                    <div class="mb-4" id="lessonInfo" style="display: none;">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-graduation-cap me-1"></i>Lesson Plan
                                </h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <strong>Total Lessons:</strong> <span id="totalLessons">-</span><br>
                                            <strong>Duration:</strong> <span id="estimatedDuration">-</span>
                                        </small>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <strong>Session Length:</strong> 45-60 min<br>
                                            <strong>Frequency:</strong> 1-2 per week
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Options -->
                    <div class="mb-4">
                        <div class="card bg-info text-white border-0">
                            <div class="card-body p-3">
                                <h6 class="mb-2">
                                    <i class="fas fa-magic me-1"></i>Quick Setup Options
                                </h6>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="autoAssignMentor" checked>
                                    <label class="form-check-label" for="autoAssignMentor">
                                        Auto-assign mentor after creation
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('mentees') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Back to Mentees
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-plus me-2"></i>Add Mentee
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3 border-0 bg-transparent">
            <div class="card-body p-2">
                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('mentees') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-list me-1"></i>View All Mentees
                    </a>
                    <a href="{{ url_for('add_mentor') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chalkboard-teacher me-1"></i>Add Mentor Instead
                    </a>
                    <a href="{{ url_for('assign_mentor') }}" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-link me-1"></i>Assign Mentors
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for enhanced functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('menteeForm');
    const nameInput = document.getElementById('name');
    const rollCallInput = document.getElementById('roll_call');
    const subjectSelect = document.getElementById('subject');
    const submitBtn = document.getElementById('submitBtn');
    const subjectCards = document.querySelectorAll('.subject-card');
    const selectedSubjectDisplay = document.getElementById('selectedSubjectDisplay');
    const selectedSubjectName = document.getElementById('selectedSubjectName');
    const changeSubjectBtn = document.getElementById('changeSubject');
    const lessonInfo = document.getElementById('lessonInfo');

    // Subject lesson data
    const subjectData = {
        'Math': { lessons: 7, duration: '3-4 weeks', icon: 'fa-calculator', color: 'primary' },
        'English': { lessons: 7, duration: '3-4 weeks', icon: 'fa-book-open', color: 'info' },
        'Science': { lessons: 3, duration: '1-2 weeks', icon: 'fa-flask', color: 'warning' },
        'Chess': { lessons: 6, duration: '2-3 weeks', icon: 'fa-chess', color: 'success' }
    };

    // Handle subject card selection
    subjectCards.forEach(card => {
        card.addEventListener('click', function() {
            const subject = this.dataset.subject;
            selectSubject(subject);
        });
    });

    function selectSubject(subject) {
        // Clear previous selections
        subjectCards.forEach(card => {
            card.classList.remove('border-primary', 'bg-primary', 'text-white');
        });

        // Highlight selected card
        const selectedCard = document.querySelector(`[data-subject="${subject}"]`);
        selectedCard.classList.add('border-primary', 'bg-primary', 'text-white');

        // Update form
        subjectSelect.value = subject;
        selectedSubjectName.textContent = subject;
        
        // Show selection display
        selectedSubjectDisplay.classList.remove('d-none');
        
        // Update lesson info
        const data = subjectData[subject];
        document.getElementById('totalLessons').textContent = data.lessons;
        document.getElementById('estimatedDuration').textContent = data.duration;
        lessonInfo.style.display = 'block';

        // Update validation
        subjectSelect.classList.remove('is-invalid');
        subjectSelect.classList.add('is-valid');
    }

    // Change subject button
    changeSubjectBtn.addEventListener('click', function() {
        // Clear selection
        subjectCards.forEach(card => {
            card.classList.remove('border-primary', 'bg-primary', 'text-white');
        });
        
        selectedSubjectDisplay.classList.add('d-none');
        lessonInfo.style.display = 'none';
        subjectSelect.value = '';
        subjectSelect.classList.remove('is-valid');
    });

    // Auto-generate student ID suggestion
    nameInput.addEventListener('blur', function() {
        if (this.value && !rollCallInput.value) {
            const nameParts = this.value.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts[nameParts.length - 1] || '';
            const suggestion = 'STU' + firstName.substring(0, 2).toUpperCase() + lastName.substring(0, 2).toUpperCase();
            rollCallInput.placeholder = `Suggestion: ${suggestion}`;
        }
    });

    // Form validation
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            
            // Show subject selection error if no subject selected
            if (!subjectSelect.value) {
                subjectSelect.classList.add('is-invalid');
            }
        } else {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding Mentee...';
            submitBtn.disabled = true;
            
            // Handle auto-assign option
            const autoAssign = document.getElementById('autoAssignMentor').checked;
            if (autoAssign) {
                // You can add logic here to redirect to assign mentor page after creation
                form.addEventListener('submit', function() {
                    setTimeout(() => {
                        window.location.href = '{{ url_for("assign_mentor") }}';
                    }, 1500);
                });
            }
        }
        
        form.classList.add('was-validated');
    });

    // Real-time validation feedback
    [nameInput, rollCallInput].forEach(input => {
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
});
</script>

<style>
.subject-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.subject-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.subject-card.border-primary {
    border-color: #0d6efd !important;
}

.form-control:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

@media (max-width: 768px) {
    .subject-card .card-body {
        padding: 1rem;
    }
    
    .subject-card i {
        font-size: 1.5rem !important;
    }
}
</style>

        <div class="card mt-4 bg-secondary border-0">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>Need Help?
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning">Adding Mentees</h6>
                        <ul class="text-light small">
                            <li>Student Name should be their full, official name</li>
                            <li>Roll Call must be unique for each student</li>
                            <li>Subject determines lesson count automatically</li>
                            <li>Mentees can be assigned mentors later</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">After Adding</h6>
                        <ul class="text-light small">
                            <li>Use "Assign Mentor" to pair with a tutor</li>
                            <li>Schedule sessions through the calendar</li>
                            <li>Track progress on the dashboard</li>
                            <li>Students graduate when lessons reach 0</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('user_guide') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-book me-1"></i>View Complete User Guide
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Add some client-side validation and user feedback
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const rollCallInput = document.getElementById('roll_call');
    const subjectSelect = document.getElementById('subject');
    
    // Real-time validation for roll call
    rollCallInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length > 0 && value.length < 3) {
            this.setCustomValidity('Roll call should be at least 3 characters long');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Show lesson count when subject is selected
    subjectSelect.addEventListener('change', function() {
        const selectedSubject = this.value;
        if (selectedSubject) {
            // You can add lesson count display logic here if needed
            console.log('Selected subject:', selectedSubject);
        }
    });
    
    // Form submission confirmation
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const rollCall = document.getElementById('roll_call').value.trim();
        const subject = document.getElementById('subject').value;
        
        if (!name || !rollCall || !subject) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }
        
        // Basic name validation
        if (name.length < 2) {
            e.preventDefault();
            alert('Please enter a valid student name.');
            document.getElementById('name').focus();
            return false;
        }
    });
});
</script>
{% endblock %}
